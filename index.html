<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Marker WebAR (MindAR + Three.js) – Debug</title>
<style>
  html,body{margin:0;padding:0;height:100%;background:#000;color:#fff;font-family:-apple-system,BlinkMacSystemFont,"Hiragino Sans",sans-serif}
  #ar-container{position:fixed;inset:0;overflow:hidden;background:#000}
  .ui{position:fixed;left:12px;right:12px;bottom:12px;display:flex;gap:8px;justify-content:space-between;align-items:center;z-index:10}
  .pill{background:rgba(0,0,0,.45);border:1px solid rgba(255,255,255,.2);border-radius:999px;padding:8px 12px}
  .btn{background:#0a84ff;border:none;color:#fff;border-radius:12px;font-weight:700;padding:10px 14px;cursor:pointer}
  .warn{position:fixed;left:12px;right:12px;top:12px;color:#ffd399;background:#3a2a04;border:1px solid #5b4310;border-radius:10px;padding:8px 10px;display:none;z-index:11}
  .log{position:fixed;left:12px;right:12px;top:56px;background:rgba(0,0,0,.65);border:1px solid rgba(255,255,255,.2);border-radius:10px;padding:8px 10px;white-space:pre-wrap;font-size:12px;max-height:34vh;overflow:auto;z-index:11;display:none}
  video#fallback{position:fixed;inset:0;width:100%;height:100%;object-fit:cover;display:none;z-index:0}
</style>
</head>
<body>
  <div id="ar-container" aria-label="AR映像領域"></div>
  <div id="warn" class="warn">Safari（アプリ内ブラウザ不可）、HTTPS、カメラ許可が必要です。</div>
  <div id="log" class="log"></div>
  <video id="fallback" playsinline autoplay muted></video>

  <div class="ui">
    <div class="pill">🎯 マーカーにカメラを向けてください</div>
    <button id="startBtn" class="btn">ARを開始</button>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/three@0.158/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-three.prod.js"></script>

  <script type="module">
    import { GLTFLoader } from "https://cdn.jsdelivr.net/npm/three@0.158/examples/jsm/loaders/GLTFLoader.js";

    const L = (m)=>{ const el=document.getElementById('log'); el.style.display='block'; el.textContent += m + "\n"; };
    window.addEventListener('error', e=> L("window.onerror: " + (e.message||e)));
    window.addEventListener('unhandledrejection', e=> L("unhandledrejection: " + (e.reason?.message||e.reason||e)));

    // 環境注意
    (function(){
      const ua = navigator.userAgent||""; const inApp=/(FBAN|FBAV|Instagram|Line|Twitter|WeChat|MicroMessenger)/i.test(ua);
      const isSafari = /^((?!chrome|android).)*safari/i.test(ua) || (navigator.platform==="MacIntel" && navigator.maxTouchPoints>1);
      if (!isSafari || inApp || location.protocol!=="https:") document.getElementById("warn").style.display="block";
    })();

    const startBtn   = document.getElementById("startBtn");
    const container  = document.getElementById("ar-container");
    const fallbackV  = document.getElementById("fallback");

    startBtn.addEventListener("click", startAR);

    async function startAR(){
      startBtn.disabled = true;
      try{
        // 1) 前座: 権限取りつつ背面deviceId探索
        const pre = await getUserMediaSafe({ video:{ facingMode:{ exact:"environment" } }, audio:false });
        if (pre) L("pre-permission OK"); else L("pre-permission FAILED (続行します)");
        const backId = await pickBackId();
        if (pre) stop(pre);

        L("chosen backId: " + (backId||"(none)"));

        // 2) MindAR起動
        const videoSettings = backId ? { deviceId:{ exact:backId } } : { facingMode:{ exact:"environment" } };
        L("videoSettings: " + JSON.stringify(videoSettings));

        const mindarThree = new window.MINDAR.IMAGE.MindARThree({
          container,
          imageTargetSrc: "./targets.mind",
          uiScanning: false,
          uiLoading: "no",
          videoSettings
        });
        const { renderer, scene, camera } = mindarThree;

        scene.add(new THREE.HemisphereLight(0xffffff,0x444466,1.0));
        const d = new THREE.DirectionalLight(0xffffff,0.9); d.position.set(1,1.5,1); scene.add(d);

        const anchor = mindarThree.addAnchor(0);

        let model;
        await new Promise((res,rej)=>{
          new GLTFLoader().load("./model.glb",(gltf)=>{ model=gltf.scene; model.scale.set(0.2,0.2,0.2); model.visible=false; anchor.group.add(model); res(); }, undefined, (e)=>rej(new Error("GLB読み込み失敗: "+(e?.message||e))));
        });

        anchor.onTargetFound = ()=>{ model.visible=true; };
        anchor.onTargetLost  = ()=>{ model.visible=false; };

        await mindarThree.start();
        L("mindarThree.start() OK");

        renderer.setAnimationLoop(()=>{ if (model?.visible) model.rotation.y += 0.01; renderer.render(scene,camera); });
      }catch(e){
        L("MindAR起動失敗: " + (e?.name||"") + " " + (e?.message||e));
        await showFallbackCamera(); // ← ここで素のカメラを表示（黒画面を回避）
      }
    }

    async function showFallbackCamera(){
      try{
        const s = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:{ exact:"environment" } }, audio:false });
        fallbackV.srcObject = s; 
        fallbackV.style.display = "block";
      }catch(e){
        L("fallback getUserMedia 失敗: " + (e?.name||"") + " " + (e?.message||e));
        alert("カメラが起動できませんでした。Safariのカメラ許可・スクリーンタイム制限・HTTPSをご確認ください。");
      }
    }

    async function getUserMediaSafe(c){ try{ return await navigator.mediaDevices.getUserMedia(c); }catch{ return null; } }
    function stop(s){ try{ s.getTracks().forEach(t=>t.stop()); }catch{} }
    async function pickBackId(){
      try{
        const devs = await navigator.mediaDevices.enumerateDevices();
        const cams = devs.filter(d=>d.kind==="videoinput");
        let hit = cams.find(d=> (d.label||"").toLowerCase().match(/back|environment|外側|デュアル/));
        return hit?.deviceId || cams[1]?.deviceId || cams[0]?.deviceId || null;
      }catch{ return null; }
    }
  </script>
</body>
</html>

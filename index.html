<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Marker WebAR (MindAR + Three.js) â€“ iOSå®‰å®šç‰ˆ</title>
<style>
  html,body{margin:0;padding:0;height:100%;background:#000;font-family:-apple-system,BlinkMacSystemFont,"Hiragino Sans",sans-serif;}
  #ar-container{position:fixed;inset:0;overflow:hidden;}
  .ui{position:fixed;left:12px;right:12px;bottom:12px;display:flex;gap:8px;justify-content:space-between;pointer-events:none;color:#fff;font-size:14px;text-shadow:0 1px 2px rgba(0,0,0,.6);}
  .pill{pointer-events:auto;background:rgba(0,0,0,.45);border:1px solid rgba(255,255,255,.2);padding:8px 10px;border-radius:999px}
  .btn{pointer-events:auto;background:#0a84ff;border:none;color:#fff;font-weight:700;padding:10px 14px;border-radius:12px;cursor:pointer}
  .warn{position:fixed;left:12px;right:12px;top:12px;color:#ffd399;background:#3a2a04;border:1px solid #5b4310;border-radius:10px;padding:8px 10px;display:none}
  .error{position:fixed;left:12px;right:12px;top:54px;color:#ffb4b4;background:#4a0c0c;border:1px solid #7a2020;border-radius:10px;padding:8px 10px;display:none;white-space:pre-wrap}
</style>
</head>
<body>
  <div id="ar-container"></div>

  <div id="warn" class="warn">Safariã§é–‹ã„ã¦ãã ã•ã„ï¼ˆã‚¢ãƒ—ãƒªå†…ãƒ–ãƒ©ã‚¦ã‚¶ã¯ã‚«ãƒ¡ãƒ©ãŒä½¿ãˆã¾ã›ã‚“ï¼‰ã€‚HTTPSã¨ã‚«ãƒ¡ãƒ©è¨±å¯ã‚‚å¿…è¦ã§ã™ã€‚</div>
  <div id="err" class="error"></div>

  <div class="ui">
    <div class="pill">ğŸ¯ ãƒãƒ¼ã‚«ãƒ¼ã«ã‚«ãƒ¡ãƒ©ã‚’å‘ã‘ã¦ãã ã•ã„</div>
    <button id="startBtn" class="btn">ARã‚’é–‹å§‹</button>
  </div>

  <!-- Three.jsï¼ˆUMDï¼‰ -->
  <script src="https://cdn.jsdelivr.net/npm/three@0.158/build/three.min.js"></script>
  <!-- MindARï¼ˆImage Tracking / Three.js çµ±åˆãƒ“ãƒ«ãƒ‰ï¼‰ -->
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-three.prod.js"></script>

  <!-- GLTFLoader ã¯ ES Module ã‚’ä½¿ã† -->
  <script type="module">
    import { GLTFLoader } from "https://cdn.jsdelivr.net/npm/three@0.158/examples/jsm/loaders/GLTFLoader.js";

    // ç°¡æ˜“ï¼šSafari/ã‚¢ãƒ—ãƒªå†…ãƒ–ãƒ©ã‚¦ã‚¶è­¦å‘Š
    (function(){
      const ua = navigator.userAgent;
      const inApp = /(FBAN|FBAV|Instagram|Line|Twitter|WeChat|MicroMessenger)/i.test(ua);
      const isSafari = /^((?!chrome|android).)*safari/i.test(ua) || (navigator.platform === "MacIntel" && navigator.maxTouchPoints > 1);
      if (!isSafari || inApp) document.getElementById("warn").style.display = "block";
      if (location.protocol !== "https:") document.getElementById("warn").style.display = "block";
    })();

    const startBtn = document.getElementById("startBtn");
    const errBox = document.getElementById("err");

    let started = false;

    startBtn.addEventListener("click", async () => {
      if (started) return;
      started = true;
      startBtn.disabled = true;

      try {
        // 1) MindARåˆæœŸåŒ–ï¼ˆèƒŒé¢ã‚«ãƒ¡ãƒ©/ç’°å¢ƒã‚«ãƒ¡ãƒ©ã‚’å¼·åˆ¶ï¼‰
        const mindarThree = new window.MINDAR.IMAGE.MindARThree({
          container: document.querySelector("#ar-container"),
          imageTargetSrc: "./targets.mind",
          uiScanning: false,
          uiLoading: "no",
          // â˜… iOSå‘ã‘ï¼šèƒŒé¢ã‚«ãƒ¡ãƒ©æŒ‡å®šï¼ˆå¤±æ•—æ™‚ã¯è‡ªå‹•ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
          //   ä¸€éƒ¨ç«¯æœ«ã§ã¯ facingMode ãŒåŠ¹ã‹ãªã„ã“ã¨ã‚‚ã‚ã‚Šã¾ã™ãŒã€æŒ‡å®šã—ã¦ãŠãã¨æˆåŠŸç‡ãŒä¸ŠãŒã‚Šã¾ã™
          videoSettings: { facingMode: { exact: "environment" } }
        });

        const { renderer, scene, camera } = mindarThree;

        // 2) ç…§æ˜
        const hemi = new THREE.HemisphereLight(0xffffff, 0x444466, 1.0); scene.add(hemi);
        const dir  = new THREE.DirectionalLight(0xffffff, 0.8); dir.position.set(1,1.5,1); scene.add(dir);

        // 3) ã‚¢ãƒ³ã‚«ãƒ¼
        const anchor = mindarThree.addAnchor(0);

        // 4) ãƒ¢ãƒ‡ãƒ«
        const loader = new GLTFLoader();
        let model;
        loader.load("./model.glb", (gltf) => {
          model = gltf.scene;
          model.scale.set(0.2,0.2,0.2);
          anchor.group.add(model);
        }, undefined, (e)=> showError("GLBèª­ã¿è¾¼ã¿å¤±æ•—: " + e.message));

        anchor.onTargetFound = () => {/* æ¼”å‡ºã‚ã‚Œã°ã“ã“ */};
        anchor.onTargetLost  = () => {/* æ¼”å‡ºã‚ã‚Œã°ã“ã“ */};

        // 5) ã‚¹ã‚¿ãƒ¼ãƒˆï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¸ã‚§ã‚¹ãƒãƒ£å†…ï¼‰
        await mindarThree.start();

        // 6) ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ«ãƒ¼ãƒ—
        renderer.setAnimationLoop(()=> {
          if (model) model.rotation.y += 0.01;
          renderer.render(scene, camera);
        });
      } catch (e) {
        showError(explainError(e));
        startBtn.disabled = false;
        started = false;
      }
    });

    function showError(msg){
      errBox.textContent = String(msg || "Unknown Error");
      errBox.style.display = "block";
    }

    // iOSã§ã‚ˆãã‚ã‚‹å¤±æ•—ã®æ–‡è¨€ã‚’åˆ†ã‹ã‚Šã‚„ã™ã
    function explainError(e){
      const msg = (e && (e.message || e.name)) ? `${e.name || ""} ${e.message || ""}` : String(e);
      if (/NotAllowedError|Permission/i.test(msg)) {
        return "ã‚«ãƒ¡ãƒ©ã®ä½¿ç”¨ãŒè¨±å¯ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚Safariã®è¨­å®šã§ã“ã®ã‚µã‚¤ãƒˆã®ã€Œã‚«ãƒ¡ãƒ©ã‚’è¨±å¯ã€ã«ã—ã¦ãã ã•ã„ã€‚";
      }
      if (/NotFoundError|DevicesNotFound|OverconstrainedError/i.test(msg)) {
        return "ã‚«ãƒ¡ãƒ©ãƒ‡ãƒã‚¤ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ç«¯æœ«ã®ã‚«ãƒ¡ãƒ©ä½¿ç”¨åˆ¶é™ã‚„ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚¿ã‚¤ãƒ è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚";
      }
      if (/TypeError|load/i.test(msg)) {
        return "ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¾ãŸã¯ãƒ¢ãƒ‡ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯çŠ¶æ³ã¨ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ï¼ˆ./targets.mind, ./model.glbï¼‰ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚";
      }
      return msg || "èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸã€‚HTTPSãƒ»Safariã§é–‹ã„ã¦ã„ã‚‹ã‹ãƒ»ã‚«ãƒ¡ãƒ©è¨±å¯ã‚’ã”ç¢ºèªãã ã•ã„ã€‚";
    }
  </script>
</body>
</html>

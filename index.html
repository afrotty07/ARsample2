<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Marker WebAR (MindAR + Three.js) â€“ iOSå®‰å®šç‰ˆ</title>
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <style>
    :root{
      --fg:#fff; --muted:#cbd2e1; --warn:#ffd399; --bg:#000; --glass:rgba(0,0,0,.45);
    }
    html,body{margin:0;padding:0;height:100%;background:var(--bg);color:var(--fg);
      font-family:-apple-system,BlinkMacSystemFont,"Hiragino Sans","YuGothic","Meiryo",sans-serif;}
    #ar-container{position:fixed;inset:0;overflow:hidden;background:#000;}
    /* ---- UI ---- */
    .top, .bottom{position:fixed;left:12px;right:12px;display:flex;gap:8px;z-index:10}
    .top{top:12px;align-items:flex-start;flex-direction:column}
    .bottom{bottom:12px;justify-content:space-between;align-items:center}
    .pill{background:var(--glass);border:1px solid rgba(255,255,255,.2);border-radius:999px;
      padding:8px 12px;backdrop-filter:blur(6px);font-size:14px}
    .btn{background:#0a84ff;border:none;color:#fff;border-radius:12px;font-weight:700;
      padding:10px 14px;cursor:pointer;font-size:14px}
    .btn:disabled{opacity:.6}
    .warn{display:none;background:#3a2a04;border:1px solid #5b4310;border-radius:10px;padding:8px 10px;font-size:13px;color:var(--warn)}
    .error{display:none;background:#4a0c0c;border:1px solid #7a2020;border-radius:10px;padding:8px 10px;font-size:13px;white-space:pre-wrap}
    .hint{font-size:13px;color:var(--muted)}
    /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ä¸­ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
    .loading{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.6);z-index:9}
    .spinner{width:44px;height:44px;border-radius:50%;border:4px solid rgba(255,255,255,.25);border-top-color:#fff;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>
<body>
  <div id="ar-container" aria-label="ARæ˜ åƒé ˜åŸŸ"></div>

  <!-- ä¸Šéƒ¨é€šçŸ¥ -->
  <div class="top">
    <div id="warn" class="warn">Safariã§é–‹ã„ã¦ãã ã•ã„ï¼ˆã‚¢ãƒ—ãƒªå†…ãƒ–ãƒ©ã‚¦ã‚¶ã¯ã‚«ãƒ¡ãƒ©ä¸å¯ï¼‰ã€‚ã“ã®ã‚µã‚¤ãƒˆã¯HTTPSã¨ã‚«ãƒ¡ãƒ©è¨±å¯ãŒå¿…è¦ã§ã™ã€‚</div>
    <div id="err" class="error"></div>
  </div>

  <!-- ä¸‹éƒ¨æ“ä½œ -->
  <div class="bottom">
    <div class="pill">ğŸ¯ ãƒãƒ¼ã‚«ãƒ¼ã«ã‚«ãƒ¡ãƒ©ã‚’å‘ã‘ã¦ãã ã•ã„</div>
    <div style="display:flex;gap:8px;align-items:center">
      <button id="startBtn" class="btn">ARã‚’é–‹å§‹</button>
    </div>
  </div>

  <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° -->
  <div id="loading" class="loading"><div class="spinner" role="status" aria-label="èª­ã¿è¾¼ã¿ä¸­"></div></div>

  <!-- Three.jsï¼ˆUMDï¼‰ -->
  <script src="https://cdn.jsdelivr.net/npm/three@0.158/build/three.min.js"></script>
  <!-- MindARï¼ˆImage Tracking / Three.jsçµ±åˆï¼‰ -->
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-three.prod.js"></script>

  <!-- GLTFLoaderã¯ES Moduleã§èª­ã¿è¾¼ã¿ -->
  <script type="module">
    import { GLTFLoader } from "https://cdn.jsdelivr.net/npm/three@0.158/examples/jsm/loaders/GLTFLoader.js";

    // ---- ç’°å¢ƒãƒã‚§ãƒƒã‚¯ï¼ˆSafari/ã‚¢ãƒ—ãƒªå†…/HTTPSï¼‰ ----
    (function(){
      const ua = navigator.userAgent || "";
      const inApp = /(FBAN|FBAV|Instagram|Line|Twitter|WeChat|MicroMessenger)/i.test(ua);
      const isSafari = /^((?!chrome|android).)*safari/i.test(ua) || (navigator.platform === "MacIntel" && navigator.maxTouchPoints > 1);
      if (!isSafari || inApp || location.protocol !== "https:") {
        document.getElementById("warn").style.display = "block";
      }
    })();

    const startBtn = document.getElementById("startBtn");
    const errBox   = document.getElementById("err");
    const loading  = document.getElementById("loading");
    const container= document.getElementById("ar-container");

    let started = false;

    startBtn.addEventListener("click", startAR);

    async function startAR(){
      if (started) return;
      started = true;
      startBtn.disabled = true;
      showError(""); // ã‚¯ãƒªã‚¢
      showLoading(true);

      try {
        // â‘  ã¾ãšæ¨©é™ã‚’å–å¾—ã—ã¤ã¤èƒŒé¢ã‚«ãƒ¡ãƒ©ã® deviceId ã‚’æ¨å®š
        const pre = await safeGetUserMedia({ video: { facingMode: { exact: "environment" } }, audio: false });
        const backId = await pickBackCameraDeviceId();
        if (pre) stopStream(pre);

        // â‘¡ MindARåˆæœŸåŒ–ï¼ˆdeviceIdå„ªå…ˆï¼‰
        const videoSettings = backId ? { deviceId: { exact: backId } }
                                     : { facingMode: { exact: "environment" } };

        const mindarThree = new window.MINDAR.IMAGE.MindARThree({
          container,
          imageTargetSrc: "./targets.mind",
          uiScanning: false,
          uiLoading: "no",
          videoSettings
        });

        const { renderer, scene, camera } = mindarThree;

        // â‘¢ ç…§æ˜ï¼ˆè»½é‡ã§è¦‹ã‚„ã™ãï¼‰
        scene.add(new THREE.HemisphereLight(0xffffff, 0x444466, 1.0));
        const dir = new THREE.DirectionalLight(0xffffff, 0.9); dir.position.set(1,1.5,1); scene.add(dir);

        // â‘£ ã‚¢ãƒ³ã‚«ãƒ¼ï¼ˆtargets.mind ã® 0ç•ªï¼‰
        const anchor = mindarThree.addAnchor(0);

        // â‘¤ ãƒ¢ãƒ‡ãƒ«èª­ã¿è¾¼ã¿ï¼ˆã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ä»˜ãï¼‰
        const loader = new GLTFLoader();
        const model = await new Promise((resolve, reject)=>{
          loader.load("./model.glb", (gltf)=>{
            const obj = gltf.scene;
            obj.scale.set(0.2,0.2,0.2);     // â˜…ã‚µã‚¤ã‚ºèª¿æ•´ï¼šå¿…è¦ã«å¿œã˜ã¦å¤‰æ›´
            obj.position.set(0,0,0);
            anchor.group.add(obj);
            resolve(obj);
          }, undefined, (e)=> reject(new Error("GLBèª­ã¿è¾¼ã¿ã«å¤±æ•—ï¼š" + (e?.message||e))));
        });

        // â‘¥ æ¤œå‡ºã‚¤ãƒ™ãƒ³ãƒˆï¼ˆæ¼”å‡ºãƒ•ãƒƒã‚¯ï¼‰
        anchor.onTargetFound = () => {
          // ä¾‹ï¼šãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³
          model.visible = true;
        };
        anchor.onTargetLost = () => {
          // ä¾‹ï¼šè¦‹å¤±ã£ãŸã‚‰ä¸€æ—¦éš ã™ï¼ˆå›ºå®šè¡¨ç¤ºã—ãŸã„ãªã‚‰æ¶ˆã•ãªã„ï¼‰
          model.visible = false;
        };
        model.visible = false; // æœ€åˆã¯éè¡¨ç¤ºâ†’Foundã§è¡¨ç¤º

        // â‘¦ èµ·å‹•ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œä¸­ãªã®ã§iOSã§ã‚‚OKï¼‰
        await mindarThree.start();
        showLoading(false);

        // â‘§ ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ«ãƒ¼ãƒ—
        renderer.setAnimationLoop(()=>{
          // ç°¡å˜ãªã‚¢ãƒ‹ãƒ¡
          if (model.visible) model.rotation.y += 0.01;
          renderer.render(scene, camera);
        });

      } catch (e) {
        showLoading(false);
        started = false;
        startBtn.disabled = false;
        showError(explainError(e));
      }
    }

    // ---- ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ -------------------------------------------------

    function showLoading(v){ loading.style.display = v ? "grid" : "none"; }
    function showError(msg){
      if (!msg) { errBox.style.display="none"; errBox.textContent=""; return; }
      errBox.textContent = msg;
      errBox.style.display = "block";
    }

    async function safeGetUserMedia(constraints){
      try { return await navigator.mediaDevices.getUserMedia(constraints); }
      catch(e){ /* æ¨©é™æœªè¨±å¯ãªã©ã€‚å¾Œæ®µã§å†è©¦è¡Œã™ã‚‹ã®ã§æ¡ã‚Šã¤ã¶ã•ãªã„ */ return null; }
    }
    function stopStream(stream){ try{ stream.getTracks().forEach(t=>t.stop()); }catch{} }

    async function pickBackCameraDeviceId(){
      try{
        // æ¨©é™ãŒãªã„ã¨labelãŒç©ºãªã®ã§ã€å…ˆã«ä¸€åº¦ getUserMedia ã‚’å©ãã®ãŒç†æƒ³ï¼ˆä¸Šã§å®Ÿæ–½ï¼‰
        const list = await navigator.mediaDevices.enumerateDevices();
        const videos = list.filter(d=> d.kind === "videoinput");
        // ãƒ©ãƒ™ãƒ«ã§èƒŒé¢ã£ã½ã„ã‚‚ã®ã‚’å„ªå…ˆ
        const hit = videos.find(d=>{
          const name = (d.label||"").toLowerCase();
          return name.includes("back") || name.includes("environment") || name.includes("å¤–å´") || name.includes("ãƒ‡ãƒ¥ã‚¢ãƒ«");
        });
        return hit ? hit.deviceId : (videos[1]?.deviceId || videos[0]?.deviceId || null);
      }catch{ return null; }
    }

    function explainError(e){
      const msg = (e && (e.message || e.name)) ? `${e.name||""} ${e.message||""}` : String(e);
      if (/NotAllowedError|Permission/i.test(msg)) {
        return "ã‚«ãƒ¡ãƒ©ã®ä½¿ç”¨ãŒè¨±å¯ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚è¨­å®š > Safari > ã‚«ãƒ¡ãƒ© ã§ã€Œè¨±å¯ã€ã«ã—ã¦ãã ã•ã„ã€‚";
      }
      if (/NotFoundError|DevicesNotFound|OverconstrainedError/i.test(msg)) {
        return "ã‚«ãƒ¡ãƒ©ãƒ‡ãƒã‚¤ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚¿ã‚¤ãƒ ã‚„MDMã®åˆ¶é™ã€ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼è¨­å®šã‚’ã”ç¢ºèªãã ã•ã„ã€‚";
      }
      if (/load|TypeError|Network/i.test(msg)) {
        return "ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚targets.mind ã¨ model.glb ã®é…ç½®ãƒ»ãƒ‘ã‚¹ãƒ»HTTPS ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚";
      }
      return msg || "èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸã€‚Safari/HTTPS/ã‚«ãƒ¡ãƒ©è¨±å¯ã‚’ã”ç¢ºèªãã ã•ã„ã€‚";
    }
  </script>
</body>
</html>

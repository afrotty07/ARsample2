<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Marker WebAR (MindAR + Three.js) ‚Äì Video Fix</title>
<style>
  html,body{margin:0;height:100%;background:#000;color:#fff;font-family:-apple-system,BlinkMacSystemFont,"Hiragino Sans",sans-serif}
  #ar{position:fixed;inset:0;overflow:hidden}
  .ui{position:fixed;left:12px;right:12px;bottom:12px;display:flex;gap:8px;justify-content:space-between;z-index:10}
  .btn{background:#0a84ff;border:none;color:#fff;border-radius:12px;font-weight:700;padding:10px 14px}
  .log{position:fixed;left:12px;right:12px;top:12px;background:rgba(0,0,0,.65);border:1px solid rgba(255,255,255,.2);border-radius:10px;padding:8px 10px;white-space:pre-wrap;font-size:12px;max-height:36vh;overflow:auto;z-index:10}
</style>
</head>
<body>
  <div id="ar"></div>
  <div id="log" class="log">Safari/HTTPS/„Ç´„É°„É©Ë®±ÂèØ„ÅåÂøÖË¶Å„Åß„Åô„ÄÇ</div>
  <div class="ui"><button id="start" class="btn">AR„ÇíÈñãÂßã„Å†„Å¥„Çá„Çì</button></div>

  <script src="https://cdn.jsdelivr.net/npm/three@0.158/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-three.prod.js"></script>
  <script type="module">
    import { GLTFLoader } from "https://cdn.jsdelivr.net/npm/three@0.158/examples/jsm/loaders/GLTFLoader.js";
    const log = (m)=>{ const el=document.getElementById('log'); el.textContent += "\n"+m; };

    async function pickBackId(){
      try{
        const list = await navigator.mediaDevices.enumerateDevices();
        const vids = list.filter(d=>d.kind==='videoinput');
        const hit = vids.find(d=> (d.label||"").toLowerCase().match(/back|environment|Â§ñÂÅ¥|„Éá„É•„Ç¢„É´/));
        return hit?.deviceId || vids[1]?.deviceId || vids[0]?.deviceId || null;
      }catch(e){ return null; }
    }

    document.getElementById('start').onclick = async ()=>{
      try{
        const pre = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:{ exact:'environment' } }, audio:false }).catch(e=>{ log("pre getUserMedia: "+e.name); return null; });
        const backId = await pickBackId();
        if (pre) pre.getTracks().forEach(t=>t.stop());

        const videoSettings = backId ? { deviceId:{ exact: backId } } : { facingMode:{ exact:'environment' } };
        const mindar = new window.MINDAR.IMAGE.MindARThree({
          container: document.getElementById('ar'),
          imageTargetSrc: './targets.mind',
          uiScanning: false,
          uiLoading: 'no',
          videoSettings
        });
        const {renderer, scene, camera} = mindar;

        // üîπ ËÉåÊôØ„ÅÆ„Éì„Éá„Ç™Êò†ÂÉè„ÅåË¶ã„Åà„Çã„Çà„ÅÜ„Å´Ë®≠ÂÆö
        renderer.setClearAlpha(0); // ËÉåÊôØ„ÇíÈÄèÈÅé
        renderer.outputColorSpace = THREE.SRGBColorSpace;
        scene.background = null;

        scene.add(new THREE.HemisphereLight(0xffffff,0x444466,1.0));
        const d = new THREE.DirectionalLight(0xffffff,0.9); d.position.set(1,1.5,1); scene.add(d);

        const anchor = mindar.addAnchor(0);
        let model;
        await new Promise((res,rej)=>{
          new GLTFLoader().load('./model.glb', (g)=>{ 
            model=g.scene; 
            model.scale.set(0.2,0.2,0.2); 
            model.visible=false; 
            anchor.group.add(model); 
            res(); 
          }, undefined, (e)=>rej(new Error('GLBË™≠„ÅøËæº„ÅøÂ§±Êïó')) );
        });

        anchor.onTargetFound = ()=>{ model.visible=true; };
        anchor.onTargetLost  = ()=>{ model.visible=false; };

        // üîπ MindARÈñãÂßãÂâç„Å´videoË¶ÅÁ¥†„ÅÆÂÜçÁîü„Çí‰øùË®ºÔºàiOSÂØæÁ≠ñÔºâ
        const videoEl = mindar.video;
        if (videoEl && videoEl.paused) {
          await videoEl.play().catch(e=>log("video.play„Ç®„É©„Éº:"+e));
        }

        await mindar.start();
        log("mindar.start OK");

        renderer.setAnimationLoop(()=>{
          if (model.visible) model.rotation.y+=0.01;
          renderer.render(scene,camera);
        });
      }catch(e){
        log("ERROR: " + (e.name||"") + " " + (e.message||e));
      }
    };
  </script>
</body>
</html>
